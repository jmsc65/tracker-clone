name: hospitals-tracker-uploads

# Controls when the action will run

on:
  workflow_dispatch:
jobs: 
  upload:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@master
    - uses: r-lib/actions/setup-r@master
 
 name: 'Install R'
description: 'Install UCRT-build of R'
inputs:
  ucrt3-release:
    description: 'release tag for UCRT3'
    required: false
    default: 'v0.5'
runs:
  using: 'composite'
  steps:
    - name: Cache R installation
      uses: actions/cache@v2
      env:
        cache-name: cache-r
      with:
        path: ~/r
        key: ${{ env.cache-name }}-${{ inputs.ucrt3-release }}

    - name: Install R
      run: |
        if [ "${{ runner.os }}" = Windows -a ! -d ~/r ] ; then
          echo "::group::Downloading and installing R"
          TAG="${{ inputs.ucrt3-release }}"
          URL=`curl -s https://api.github.com/repos/kalibera/ucrt3/releases | \
            sed -n 's!^ *\"*browser_download_url\"*: \"\(.*/download/'$TAG'/R-devel-win.*\)\"!\1!p'`
          curl -s -L $URL > rinst.exe
          if [ ! -x rinst.exe ] ; then
            echo "::error ::ERROR: failed to download R installer"
            exit 1
          fi
          ./rinst.exe //VERYSILENT //SUPPRESSMSGBOXES //CURRENTUSER //DIR=`cygpath -wa ~/r`
          rm -f rinst.exe
          if [ ! -x ~/r/bin/R.exe ] ; then
            echo "::error ::ERROR: failed to install R"
            exit 1
          fi
          echo "::endgroup::"
        fi
      shell: bash

    - name: Set up environment for R
      run: |
        if [ "${{ runner.os }}" = Windows ] ; then
          echo "::group::Setting up environment for R"
          echo ~/r/bin >> $GITHUB_PATH
          # Prevent interference from pre-installed R
          echo "R_LIBS_USER=NULL" >> $GITHUB_ENV
          echo "R_LIBS_SITE=NULL" >> $GITHUB_ENV
          # Define a time-zone
          echo "TZ=Europe/Prague" >> $GITHUB_ENV
          echo "::endgroup::"
        fi
      shell: bash

# Load libraries
    - name: Install packages
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
          install.packages(c(
            "curl",
            "tidyverse",
            "dplyr",
            "lubridate",
            "readr",
            "Rcpp",
            "sf",
            "ggmap",
            "data.table"
          ))
      shell: Rscript {0}
         
    # Run scripts
    
    - name: Cancelled ops
      run: |
          source('scripts/cancelled-operations.R')
      shell: Rscript {0}
      

      
 # commit & push
    - name: Commit files
      run: |
        git config --local user.name actions-user
        git config --local user.email "actions@github.com"
        git add data/*
        git commit -am "GH ACTION Headlines $(date)"
        git push origin main
      env:
        REPO_KEY: ${{secrets.GITHUB_TOKEN}}
        username: github-actions
